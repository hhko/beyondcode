name: Build C# Gym

on:
  workflow_dispatch:
  push:
    branches:
      - main
    # paths: [ 'src/**', 'tests/**', '.github/workflows/dotnet-ci.yml' ]
    paths-ignore:
      - '**.md'
      - '**.pptx'
      - '**.png'
      - '**.ps1'
      #- '.github/workflows/build-docs.yml'
  # pull_request:
  #   branches: [ main ]


# 1. publish-unit-test-result-action: ì†”ë£¨ì…˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ trx ì¶”ê°€: Summary
#  - https://github.com/EnricoMi/publish-unit-test-result-action?tab=readme-ov-file#permissions
# 2. dorny/test-reporter: ì†”ë£¨ì…˜ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ ëª©ë¡
#   - https://github.com/dorny/test-reporter
permissions:
  checks: write
  pull-requests: write
  # contents: read
  # actions: read

jobs:
  build:
    name: Build

    # ë¹Œë“œ í™˜ê²½ ê²½ìš°ì˜ ìˆ˜ ì •ì˜
    strategy:
      matrix:
        dotnet-version: [ '9.0.x' ]
        configuration: [ Release ]
        os: [ ubuntu-24.04 ]

    # ë¹Œë“œ í™˜ê²½ ì§€ì •
    runs-on: ${{ matrix.os }}

    # $GITHUB_OUTPUT
    # $GITHUB_STEP_SUMMARY

    # í™˜ê²½ ë³€ìˆ˜
    #  - ê·œì¹™: ${{ env.í™˜ê²½_ë³€ìˆ˜_ì´ë¦„ }}
    #  - ì˜ˆì œ: ${{ env.solution_dir }}
    # ì˜ˆì•½ ë³€ìˆ˜
    #  - ${{ github.workspace }}
    #  - ${{ github.run_number }}
    #  - ${{ github.run_id }}
    env:
      solution_dir:       ./02-labs/DDD/03_DddGym/Part01-Monolithic/DddGym
      build_dir:          ./02-labs/DDD/03_DddGym/Part01-Monolithic/DddGym/.build
      solution_filename:  DddGym.sln

    steps:
      # í˜•ìƒê´€ë¦¬ ìµœì‹  ì†ŒìŠ¤ ë°›ê¸°
      - name: Checkout
        uses: actions/checkout@v4

      # Git Commit SHA ì–»ê¸°
      #   - Deprecating save-state and set-output commands: https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/
      #   - GitHub Actionsì—ì„œ output ë³€ìˆ˜ì˜ ë¬¸ë²• ë³€ê²½: https://blog.outsider.ne.kr/1651
      #   - Github Actions and creating a short SHA hash: https://dev.to/hectorleiva/github-actions-and-creating-a-short-sha-hash-8b7
      #
      # ë™ì  ë³€ìˆ˜ ë§Œë“¤ê¸°
      # ê·œì¹™ 1. $GITHUB_OUTPUTì€ "steps.vars.outputs"ì„ ì§€ì •í•œë‹¤.
      # ê·œì¹™ 2. "í‚¤=ê°’" í˜•ì‹ìœ¼ë¡œ outputsì„ ì •ì˜í•œë‹¤.
      # ì˜ˆ. ${{ steps.vars.outputs.short_sha }}
      - name: Set Short Git Commit SHA
        id: vars
        run: |
          calculatedSha=$(git rev-parse --short ${{ github.sha }})
          echo "short_sha=$calculatedSha" >> $GITHUB_OUTPUT

      # .NET SDK ì„¤ì¹˜
      - name: Setup .NET SDK ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      # ì†”ë£¨ì…˜ íŒ¨í‚¤ì§€ ë³µì›
      - name: Restore NuGet Packages
        run: |
          dotnet restore ${{ env.solution_dir }}/${{ env.solution_filename }} \
            --verbosity q

      # ì†”ë£¨ì…˜ ë¹Œë“œ
      - name: Build
        run: |
          dotnet build ${{ env.solution_dir }}/${{ env.solution_filename }} \
            --no-restore \
            --configuration ${{ matrix.configuration }} \
            --verbosity q

      # ì†”ë£¨ì…˜ í…ŒìŠ¤íŠ¸
      #
      # ê²°ê³¼: coverage.cobertura.xml, logs.trx
      #   {í…ŒìŠ¤íŠ¸ í”„ë¡œì íŠ¸}
      #     â””â”€TestResults
      #         â”œâ”€0ca60e99-32fb-43ac-bbd3-01f5a5ef6886        : XPlat Code Coverage í´ë”
      #         â”‚   â””â”€coverage.cobertura.xml                  : ì½”ë“œ ì»¤ë²„ë¦¬ì§€ íŒŒì¼(dotnet-coverage merge ëŒ€ìƒ)
      #         â”œâ”€{username}_{hostname}_2024-03-14_15_16_30   : trx ë¡œê·¸ í´ë”
      #         â”‚   â””â”€In
      #         â”‚       â””â”€{hostname}
      #         â”‚           â””â”€coverage.cobertura.xml          : ì½”ë“œ ì»¤ë²„ë¦¬ì§€ íŒŒì¼(ì‚¬ìš© ì•ˆí•¨, Junit ë¡œê·¸ ìƒì„±ì‹œ ìë™ ìƒì„±ë¨)
      #         â””â”€logs.trx                                    : trx ë¡œê·¸ íŒŒì¼
      - name: Test
        run: |
          dotnet test ${{ env.solution_dir }}/${{ env.solution_filename }} \
            --configuration ${{ matrix.configuration }} \
            --no-restore \
            --no-build \
            --verbosity q \
            --collect "XPlat Code Coverage" \
            --logger "trx;LogFileName=logs.trx"

            # .runsettings ì„¤ì • íŒŒì¼ ì‚¬ìš©í•  ë•Œ
            #   --settings ${{ env.solution_dir }}/.runsettings
            # vs.
            # .runsettings ì„¤ì • íŒŒì¼ ì‚¬ìš©í•˜ì§€ ì•Šì„ ë•Œ
            #   --collect "XPlat Code Coverage" \
            #   --logger "trx;LogFileName=logs.trx"

      # ì½”ë“œ ì»¤ë²„ë¦¬ì§€
      #  - https://github.com/danielpalme/ReportGenerator-GitHub-Action
      #
      # ê²°ê³¼: Cobertura.xml, SummaryGithub.md
      #   {ì†”ë£¨ì…˜}
      #    â””â”€.build
      #        â””â”€coverage
      #             â”œâ”€Cobertura.xml
      #             â””â”€SummaryGithub.md
      - name: Generate Coverage Reports
        uses: danielpalme/ReportGenerator-GitHub-Action@5.4.1
        if: always()
        with:
          reports: ${{ env.solution_dir }}/**/*.cobertura.xml
          targetdir: ${{ env.build_dir }}/coverage
          reporttypes: 'Cobertura;MarkdownSummaryGithub'
          verbosity: "Warning"
          title: "Code Coverage"
          tag: "${{ github.run_number }}_${{ github.run_id }}"
          customSettings: ""                # https://github.com/danielpalme/ReportGenerator/wiki/Settings.
          toolpath: "reportgeneratortool"   # dotnet tool.

      # ì½”ë“œ ì»¤ë²„ëŸ¬ì§€ $GITHUB_STEP_SUMMARYì— ì¶”ê°€
      - name: Publish Coverage Reports in Build Summary
        if: always()
        run: cat "${{ env.build_dir }}/coverage/SummaryGithub.md" >> $GITHUB_STEP_SUMMARY
        shell: bash

      # í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ
      #  - https://github.com/dorny/test-reporter?tab=readme-ov-file
      #
      # ê²°ê³¼: Test Report
      #   23 passed, 0 failed and 0 skipped
      #   Report	                                                                                Passed	Failed	Skipped	Time
      #   ./template/Assets/Domains/Tests/Crop.Hello.Domain.Unit/TestResults/logs.trx	               1âœ…                   3s
      #   ./template/Assets/Frameworks/Tests/Crop.Hello.Framework.Tests.Unit/TestResults/logs.trx	   7âœ…                   4s
      #   ./template/Backend/Api/Tests/Crop.Hello.Api.Tests.Integration/TestResults/logs.trx	       2âœ…                   4s
      #   ./template/Backend/Api/Tests/Crop.Hello.Api.Tests.Unit/TestResults/logs.trx	              12âœ…      1            4s
      - name: Publish Test Report
        uses: dorny/test-reporter@v1.9.1
        if: always()
        with:
          name: Test Report
          path: "${{ env.solution_dir }}/**/*.trx"
          reporter: dotnet-trx

      # # Publish-Unit-Test-Result-Action: https://github.com/EnricoMi/publish-unit-test-result-action?tab=readme-ov-file#permissions
      # #
      # # ê²°ê³¼: GitHub Summary
      # #   Test Results
      # #   â€‡4 filesâ€„â€ƒâ€‡4 suitesâ€„â€ƒâ€‚1s â±ï¸
      # #   22 testsâ€ƒ22 âœ…â€ƒ0 ğŸ’¤â€ƒ0 âŒ
      # #   23 runsâ€Šâ€ƒ23 âœ…â€ƒ0 ğŸ’¤â€ƒ0 âŒ
      # - name: Publish Test Summary
      #   uses: EnricoMi/publish-unit-test-result-action@v2.18.0
      #   if: always()
      #   with:
      #     files: |
      #       ${{ env.solution_dir }}/**/*.trx
      #     check_name: "Test Summary"

      # # CodeCoverageSummary: https://github.com/irongut/CodeCoverageSummary
      # #
      # # ê²°ê³¼: code-coverage-results.md
      # #   Package                                 | Line Rate | Branch Rate | Complexity  | Health
      # #   --------                                | --------- | ----------- | ----------  | ------
      # #   Crop.Hello.Api                          | 74%       | 88%         | 11          | â–
      # #   Crop.Hello.Api.Adapters.Infrastructure  | 51%       | 57%         | 39          | â–
      # #   Crop.Hello.Api.Adapters.Persistence     | 50%       | 100%        | 2           | â–
      # #   Crop.Hello.Api.Application              | 50%       | 100%        | 2           | â–
      # #   Crop.Hello.Api.Domain                   | 100%      | 100%        | 1           | âœ”
      # #   Crop.Hello.Framework                    | 71%       | 50%         | 7           | â–
      # #   Crop.Hello.Framework.Contracts          | 43%       | 38%         | 64          | âŒ
      # #   **Summary**                             | **52%** (107 / 205) | **52%** (26 / 50) | **126** | â–
      # - name: Publish Code Coverage Report
      #   uses: irongut/CodeCoverageSummary@v1.3.0
      #   with:
      #     filename: "${{ env.build_dir }}/coverage/Cobertura.xml"     # ë¨¸ì§€ëœ Cobertura.xml íŒŒì¼
      #     badge: true
      #     fail_below_min: false # just informative for now
      #     format: markdown
      #     hide_branch_rate: false
      #     hide_complexity: false
      #     indicators: true
      #     output: both
      #     #thresholds: "10 30"
      #
      # # - name: "ì¶œë ¥"
      # #   run: |
      # #     #find "$(pwd)/.build"
      # #     find . -type f -name "code-coverage-results.md"
      #
      # - name: Publish Coverage Reports in Build Summary
      #   run: cat ./code-coverage-results.md >> $GITHUB_STEP_SUMMARY
      #   shell: bash

      # - name: Add Coverage PR Comment
      #   uses: marocchino/sticky-pull-request-comment@v2
      #   if: github.event_name == 'pull_request'
      #   with:
      #     recreate: true
      #     path: code-coverage-results.md

      # # https://github.com/irongut/CodeCoverageSummary
      # - name: Publish Code Coverage Report
      #   uses: irongut/CodeCoverageSummary@v1.3.0
      #   with:
      #     filename: ${{ env.coverage_out_cobertura_file }}
      #     badge: true
      #     fail_below_min: false # just informative for now
      #     format: markdown
      #     hide_branch_rate: false
      #     hide_complexity: false
      #     indicators: true
      #     output: both
      #     #thresholds: "10 30"

      # í…ŒìŠ¤íŠ¸ì™€ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ coverage.cobertura.xml íŒŒì¼ ìƒì„±
      #   - name: Find coverage output path
      #     run: |
      #       cp $(find . -name "coverage.cobertura.xml") .