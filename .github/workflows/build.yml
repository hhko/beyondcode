name: build

# TODO: PRì¼ ë•Œ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ëŒ“ê¸€ ì¶”ê°€
on:
  workflow_dispatch:
  push:
    branches:
      - main
    # paths: [ 'src/**', 'tests/**', '.github/workflows/dotnet-ci.yml' ]
    paths-ignore:
      - '**.md'
      - '**.pptx'
      - '**.png'
      #- '.github/workflows/build-docs.yml'
      #- 'docs/**'
  # pull_request:
  #   branches: [ main ]


# # ì†”ë£¨ì…˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ trx ì¶”ê°€
# #   - dorny/test-reporter@v1
# #   - Error: HttpError: Resource not accessible by integration
# permissions:
#   checks: write

# ì†”ë£¨ì…˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ trx ì¶”ê°€
#  - https://github.com/EnricoMi/publish-unit-test-result-action?tab=readme-ov-file#permissions
#    2024-12-22 22:46:33 +0000
#     - github.GithubRetry
#     - INFO
#     - Request POST /repos/hhko/better-code-with-ddd/check-runs failed with 403: Forbidden

permissions:
  checks: write
  pull-requests: write

jobs:
  build:
    name: Build

    # ë¹Œë“œ í™˜ê²½ ê²½ìš°ì˜ ìˆ˜ ì •ì˜
    strategy:
      matrix:
        dotnet-version: [ '9.0.x' ]
        configuration: [ Release ]
        os: [ ubuntu-24.04 ]

    # ë¹Œë“œ í™˜ê²½ ì§€ì •
    runs-on: ${{ matrix.os }}
    #runs-on: ubuntu-22.04

    # $GITHUB_OUTPUT
    # $GITHUB_STEP_SUMMARY

    # í™˜ê²½ ë³€ìˆ˜
    #  - ê·œì¹™: ${{ env.í™˜ê²½_ë³€ìˆ˜_ì´ë¦„ }}
    #  - ì˜ˆì œ: ${{ env.solution_dir }}
    # ì˜ˆì•½ ë³€ìˆ˜
    #  - ${{ github.workspace }}
    env:
      solution_file:                ./Template/Hello.sln
      coverage_in_cobertura_files:  ./Template/**/*.cobertura.xml
      coverage_out_dir:             ./Template/.build/coverage/output
      coverage_out_cobertura_file:  ./Template/.build/coverage/cobertura.xml
      #testresult_dirs:             ./Template/**/TestResults/**/*
      trx_files:                    ./Template/**/*.trx

    steps:
      # í˜•ìƒê´€ë¦¬ ìµœì‹  ì†ŒìŠ¤ ë°›ê¸°
      - name: Checkout
        uses: actions/checkout@v4

      # Git Commit SHA ì–»ê¸°
      #   - Deprecating save-state and set-output commands: https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/
      #   - GitHub Actionsì—ì„œ output ë³€ìˆ˜ì˜ ë¬¸ë²• ë³€ê²½: https://blog.outsider.ne.kr/1651
      #   - Github Actions and creating a short SHA hash: https://dev.to/hectorleiva/github-actions-and-creating-a-short-sha-hash-8b7
      #
      # ë™ì  ë³€ìˆ˜ ë§Œë“¤ê¸°
      # ê·œì¹™ 1. $GITHUB_OUTPUTì€ "steps.vars.outputs"ì„ ì§€ì •í•œë‹¤.
      # ê·œì¹™ 2. "í‚¤=ê°’" í˜•ì‹ìœ¼ë¡œ outputsì„ ì •ì˜í•œë‹¤.
      # ì˜ˆ. ${{ steps.vars.outputs.short_sha }}
      - name: Set Short Git Commit SHA
        id: vars
        run: |
          calculatedSha=$(git rev-parse --short ${{ github.sha }})
          echo "short_sha=$calculatedSha" >> $GITHUB_OUTPUT

      # .NET SDK ì„¤ì¹˜
      - name: Setup .NET SDK ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      # ì†”ë£¨ì…˜ íŒ¨í‚¤ì§€ ë³µì›
      - name: Restore NuGet Packages
        run: |
          dotnet restore ${{ env.solution_file }} \
            --verbosity q

      # ì†”ë£¨ì…˜ ë¹Œë“œ
      - name: Build
        run: |
          dotnet build ${{ env.solution_file }} \
              --no-restore \
              --configuration ${{ matrix.configuration }} \
              --verbosity q

      # ì†”ë£¨ì…˜ í…ŒìŠ¤íŠ¸
      #
      # {í…ŒìŠ¤íŠ¸ í”„ë¡œì íŠ¸}
      #   â””â”€TestResults
      #       â”œâ”€0ca60e99-32fb-43ac-bbd3-01f5a5ef6886        : XPlat Code Coverage í´ë”
      #       â”‚   â””â”€coverage.cobertura.xml                  : ì½”ë“œ ì»¤ë²„ë¦¬ì§€ íŒŒì¼(dotnet-coverage merge ëŒ€ìƒ)
      #       â”œâ”€{username}_{hostname}_2024-03-14_15_16_30   : trx ë¡œê·¸ í´ë”
      #       â”‚   â””â”€In
      #       â”‚       â””â”€{hostname}
      #       â”‚           â””â”€coverage.cobertura.xml          : ì½”ë“œ ì»¤ë²„ë¦¬ì§€ íŒŒì¼(ì‚¬ìš© ì•ˆí•¨, Junit ë¡œê·¸ ìƒì„±ì‹œ ìë™ ìƒì„±ë¨)
      #       â””â”€logs.trx                                    : trx ë¡œê·¸ íŒŒì¼

      # í…ŒìŠ¤íŠ¸ì™€ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ coverage.cobertura.xml íŒŒì¼ ìƒì„±
      #   - name: Find coverage output path
      #     run: |
      #       cp $(find . -name "coverage.cobertura.xml") .
      - name: Test
        run: |
          dotnet test ${{ env.solution_file }} \
              --configuration ${{ matrix.configuration }} \
              --no-restore \
              --no-build \
              --collect "XPlat Code Coverage" \
              --logger "trx;LogFileName=logs.trx" \
              --verbosity q

      # {ì†”ë£¨ì…˜}
      #  â””â”€.build
      #      â””â”€coverage
      #           â”œâ”€coverage.cobertura.merged.xml
      #           â””â”€report
      #                â”œâ”€...
      #                â””â”€SummaryGithub.md

      # https://github.com/danielpalme/ReportGenerator-GitHub-Action
      #
      # ê²°ê³¼ë¬¼
      #  - ./Template/.build/coverage/output/Cobertura.xml
      #  - ./Template/.build/coverage/output/SummaryGithub.md
      #
      # .dotnet toool ì„¤ì¹˜ ëª…ë ¹
      #   /usr/share/dotnet/dotnet tool install dotnet-reportgenerator-globaltool \
      #     --tool-path reportgeneratortool \
      #     --version 5.4.1 \
      #     --ignore-failed-sources
      #
      # reportgenerator ëª…ë ¹
      #   /home/runner/work/better-code-with-ddd/better-code-with-ddd/reportgeneratortool/reportgenerator \
      #     -reports:./Template/**/*.cobertura.xml \                  <- ì…ë ¥ íŒŒì¼ Nê°œ
      #     -targetdir:./Template/.build/coverage/output \            <- ì¶œë ¥ ê²½ë¡œ
      #     -reporttypes:Cobertura;MarkdownSummaryGithub \            <- ì¶œë ¥ íƒ€ì…
      #     -sourcedirs: \
      #     -historydir: \
      #     -plugins: \
      #     -assemblyfilters:+* \
      #     -classfilters:+* \
      #     -filefilters:+* \
      #     -riskhotspotassemblyfilters:+* \
      #     -riskhotspotclassfilters:+* \
      #     -verbosity:Info \
      #     -title:Code Coverage \                                    <- ì œëª©
      #     -tag:2_12382597103
      #     -license:
      - name: Generate Coverage Reports
        uses: danielpalme/ReportGenerator-GitHub-Action@5.4.1
        with:
          reports: '${{ env.coverage_in_cobertura_files }}'
          targetdir: '${{ env.coverage_out_dir }}'
          reporttypes: 'Cobertura;MarkdownSummaryGithub'
          verbosity: "Info"
          title: "Code Coverage"
          tag: "${{ github.run_number }}_${{ github.run_id }}"
          customSettings: ""                # https://github.com/danielpalme/ReportGenerator/wiki/Settings.
          toolpath: "reportgeneratortool"   # dotnet tool.

      - name: Publish Coverage Reports in Build Summary
        run: cat "${{ env.coverage_out_dir }}/SummaryGithub.md" >> $GITHUB_STEP_SUMMARY
        shell: bash

      # https://github.com/EnricoMi/publish-unit-test-result-action?tab=readme-ov-file#permissions
      # GitHub Summary
      # Test Results
      # â€‡4 filesâ€„â€ƒâ€‡4 suitesâ€„â€ƒâ€‚1s â±ï¸
      # 22 testsâ€ƒ22 âœ…â€ƒ0 ğŸ’¤â€ƒ0 âŒ
      # 23 runsâ€Šâ€ƒ23 âœ…â€ƒ0 ğŸ’¤â€ƒ0 âŒ
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2.18.0
        if: always()
        with:
          files: |
            ${{ env.trx_files }}

      - name: ì¶œë ¥
        run: |
          echo "ì¶œë ¥"
          pwd

          echo "./.build ëª¨ë“  íŒŒì¼"
          find ./.build

      # # https://github.com/irongut/CodeCoverageSummary
      # - name: Publish Code Coverage Report
      #   uses: irongut/CodeCoverageSummary@v1.3.0
      #   with:
      #     filename: ${{ env.coverage_out_cobertura_file }}
      #     badge: true
      #     fail_below_min: false # just informative for now
      #     format: markdown
      #     hide_branch_rate: false
      #     hide_complexity: false
      #     indicators: true
      #     output: both
      #     #thresholds: "10 30"

      

      # # ì²¨ë¶€ íŒŒì¼
      # - name: Upload Test Results
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: Test-Results
      #     path: ${{ env.testresult_dirs }}
      #     retention-days: 5

      # # ì²¨ë¶€ íŒŒì¼
      # - name: Upload Combined Coverage XML
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: coverage
      #     path: ${{ env.coverage_out_cobertura_file }}
      #     retention-days: 5

    #   # ì†”ë£¨ì…˜ í…ŒìŠ¤íŠ¸ ìƒì„¸ ë³´ê³ ì„œ ìƒì„±
    #   - name: Create test detail report
    #     uses: dorny/test-reporter@v1
    #     if: always()
    #     with:
    #       name: Test Detail Report
    #       path: "tests/**/logs.trx"
    #       reporter: dotnet-trx

    #   # dotnet-coverage ë„êµ¬ ì„¤ì¹˜
    #   - name: Install dotnet-coverage tool
    #     run: dotnet tool install -g dotnet-coverage --version 17.9.6

    #   # ì†”ë£¨ì…˜ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ í´ë” ìƒì„±
    #   - name: Create coverage folder
    #     run: mkdir -p ${{ env.coverage_dir }}

    #   # ì†”ë£¨ì…˜ ì½”ë“œ ì»¤ë²„ì§€ë¦¬ ë³‘í•©
    #   #   Nê°œ coverage.cobertura.xml íŒŒì¼ì„ 1ê°œ coverage.cobertura.merged.xmlë¡œ í†µí•©
    #   - name: Convert .coverage.xml to .cobertura.merged.xml
    #     run: |
    #       dotnet-coverage merge "**/TestResults/*/*.cobertura.xml" \
    #           -f cobertura \
    #           -o ${{ env.coverage_path }}

      # ì†”ë£¨ì…˜ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ ìƒì„±

      # {ì†”ë£¨ì…˜}
      #  â””â”€.results
      #      â””â”€coverage
      #           â”œâ”€coverage.cobertura.merged.xml
      #           â””â”€report
      #                â”œâ”€...
      #                â””â”€SummaryGithub.md
    #   - name: Create coverage markdown file
    #     uses: danielpalme/ReportGenerator-GitHub-Action@5.2.2
    #     with:
    #       reports: '${{ env.coverage_path }}'
    #       targetdir: '${{ env.coverage_dir }}/report'
    #       reporttypes: 'MarkdownSummaryGithub;Html'

    #   # ì†”ë£¨ì…˜ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ Summary ì—…ë¡œë“œ
    #   - name: Upload coverage markdown into github actions summary
    #     run: cat ${{ env.coverage_dir }}/report/SummaryGithub.md >> $GITHUB_STEP_SUMMARY

    #   # ì†”ë£¨ì…˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ Artifacts ì—…ë¡œë“œ
    #   - name: Upload coverage files into github actions artifacts
    #     uses: actions/upload-artifact@v4
    #     with:
    #       name: coverage_${{ matrix.dotnet-version }}_sha-${{ steps.vars.outputs.short_sha }}
    #       path: ${{ env.coverage_dir }}/report

    #   # ì†”ë£¨ì…˜ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ì „ì†¡(Codecov)
    #   - name: Upload coverage reports to Codecov
    #     uses: codecov/codecov-action@v4.0.1
    #     with:
    #       token: ${{ secrets.CODECOV_TOKEN }}
    #       slug: hhko/ArchDdd